name: Docker Build with Dependency Caching (Fast)

on:
  workflow_call:
    inputs:
      dockerfile-path:
        description: 'Path to the Dockerfile'
        required: false
        type: string
        default: '.'
      context:
        description: 'Build context directory'
        required: false
        type: string
        default: '.'
      test-command:
        description: 'Command to run for testing'
        required: false
        type: string
        default: 'echo "No tests specified"'
      dependency-files:
        description: 'Additional dependency files to include in hash (space-separated)'
        required: false
        type: string
        default: ''
      time-bucket-format:
        description: 'Date format for time bucket (default: monthly YYYY-MM)'
        required: false
        type: string
        default: '%Y-%m'
      runtime-image-name:
        description: 'Name for the final runtime image'
        required: false
        type: string
        default: 'app:test'
      runner:
        description: 'GitHub runner to use'
        required: false
        type: string
        default: 'ubuntu-latest'
      use-base-image:
        description: 'Use monthly base image as foundation (faster builds)'
        required: false
        type: boolean
        default: true
      r-version:
        description: 'R version to install (e.g., 4.4.0, 4.3.2). If not specified, uses latest available.'
        required: false
        type: string
        default: ''
      bioc-version:
        description: 'Bioconductor version (e.g., 3.20, 3.19). Overrides .bioc_version file if specified.'
        required: false
        type: string
        default: ''
      python-version:
        description: 'Python version to install (e.g., 3.11, 3.12). If not specified, uses system default.'
        required: false
        type: string
        default: ''
      node-version:
        description: 'Node.js version to install (e.g., 20, 18, 20.x). If not specified, uses latest LTS.'
        required: false
        type: string
        default: '20'
      go-version:
        description: 'Go version to install (e.g., 1.21.5, 1.22.0). If not specified, uses default.'
        required: false
        type: string
        default: '1.21.5'
      ruby-version:
        description: 'Ruby version to install (e.g., 3.2, 3.3). If not specified, uses system default.'
        required: false
        type: string
        default: ''
      rust-version:
        description: 'Rust version/channel to install (e.g., stable, 1.75.0). If not specified, uses stable.'
        required: false
        type: string
        default: 'stable'
      push-images:
        description: 'Push dependency and runtime images to GHCR'
        required: false
        type: boolean
        default: true
      push-runtime:
        description: 'Push runtime image to GHCR as :latest (only when push-images is true and on main/master branch)'
        required: false
        type: boolean
        default: false
      skip-runtime:
        description: 'Skip building runtime image entirely (overrides push-runtime and test-command)'
        required: false
        type: boolean
        default: false

jobs:
  build-and-test:
    runs-on: ${{ inputs.runner }}
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull base dependency image
        id: pull-base
        if: inputs.use-base-image
        run: |
          # Try to pull current month's base image
          BASE_TAG=$(date +"${{ inputs.time-bucket-format }}")
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          BASE_IMAGE="ghcr.io/${REPO_LOWER}/base-deps:${BASE_TAG}"
          
          echo "base-tag=${BASE_TAG}" >> $GITHUB_OUTPUT
          echo "base-image=${BASE_IMAGE}" >> $GITHUB_OUTPUT
          
          if docker pull "${BASE_IMAGE}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Base image found: ${BASE_IMAGE}"
          else
            # Fallback to latest if current month doesn't exist
            echo "âš ï¸  Current month's base not found, trying latest..."
            BASE_IMAGE="ghcr.io/${REPO_LOWER}/base-deps:latest"
            
            if docker pull "${BASE_IMAGE}" 2>/dev/null; then
              echo "exists=true" >> $GITHUB_OUTPUT
              echo "base-image=${BASE_IMAGE}" >> $GITHUB_OUTPUT
              echo "âœ… Using latest base image: ${BASE_IMAGE}"
            else
              echo "exists=false" >> $GITHUB_OUTPUT
              echo "âŒ No base image found, will build from scratch"
            fi
          fi
      
      - name: Calculate dependency hash and time bucket
        id: cache-key
        run: |
          # Calculate SHA256 hash of all dependency files
          DEPS_SHA=""
          
          # Hash deps/ directory if it exists
          if [ -d "deps" ]; then
            DEPS_HASH=$(find deps -type f -print0 2>/dev/null | sort -z | xargs -0 sha256sum 2>/dev/null | sha256sum | cut -d' ' -f1)
            DEPS_SHA="${DEPS_SHA}${DEPS_HASH}"
          fi
          
          # Hash common dependency files
          DEP_FILES="apt.txt requirements.txt pyproject.toml renv.lock DESCRIPTION NAMESPACE .bioc_version .tool-versions .python-version .ruby-version .node-version .r-version package.json package-lock.json Gemfile Gemfile.lock go.mod go.sum Cargo.toml Cargo.lock"
          
          # Add custom dependency files from input
          if [ -n "${{ inputs.dependency-files }}" ]; then
            DEP_FILES="${DEP_FILES} ${{ inputs.dependency-files }}"
          fi
          
          for file in $DEP_FILES; do
            if [ -f "$file" ]; then
              FILE_HASH=$(sha256sum "$file" | cut -d' ' -f1)
              DEPS_SHA="${DEPS_SHA}${FILE_HASH}"
            fi
          done
          
          # If no dependency files found, use a default hash
          if [ -z "$DEPS_SHA" ]; then
            DEPS_SHA="no-deps"
          else
            # Hash the concatenated hashes for final dependency hash
            DEPS_SHA=$(echo -n "$DEPS_SHA" | sha256sum | cut -d' ' -f1)
          fi
          
          # Calculate time bucket with custom format
          TIME_BUCKET=$(date +"${{ inputs.time-bucket-format }}")
          
          # Combine into cache key
          CACHE_KEY="${DEPS_SHA}-${TIME_BUCKET}"
          
          echo "deps-sha=${DEPS_SHA}" >> $GITHUB_OUTPUT
          echo "time-bucket=${TIME_BUCKET}" >> $GITHUB_OUTPUT
          echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
          
          echo "Dependency hash: ${DEPS_SHA}"
          echo "Time bucket: ${TIME_BUCKET}"
          echo "Cache key: ${CACHE_KEY}"
      
      - name: Pull existing dependency image if available
        id: pull-deps
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          DEPS_IMAGE="ghcr.io/${REPO_LOWER}/deps:${{ steps.cache-key.outputs.cache-key }}"
          echo "deps-image=${DEPS_IMAGE}" >> $GITHUB_OUTPUT
          
          if docker pull "${DEPS_IMAGE}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Dependency image found in cache: ${DEPS_IMAGE}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Dependency image not found in cache: ${DEPS_IMAGE}"
          fi
      
      - name: Build dependency image
        if: steps.pull-deps.outputs.exists == 'false'
        run: |
          echo "ðŸ”¨ Building dependency image..."
          
          # Prepare build args for language versions
          BUILD_ARGS=""
          if [ -n "${{ inputs.r-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg R_VERSION=${{ inputs.r-version }}"
          fi
          if [ -n "${{ inputs.bioc-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg BIOC_VERSION=${{ inputs.bioc-version }}"
          fi
          if [ -n "${{ inputs.python-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg PYTHON_VERSION=${{ inputs.python-version }}"
          fi
          if [ -n "${{ inputs.node-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg NODE_VERSION=${{ inputs.node-version }}"
          fi
          if [ -n "${{ inputs.go-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg GO_VERSION=${{ inputs.go-version }}"
          fi
          if [ -n "${{ inputs.ruby-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg RUBY_VERSION=${{ inputs.ruby-version }}"
          fi
          if [ -n "${{ inputs.rust-version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS --build-arg RUST_VERSION=${{ inputs.rust-version }}"
          fi
          
          # If we have a base image, use it to speed up the build
          if [ "${{ inputs.use-base-image }}" == "true" ] && [ "${{ steps.pull-base.outputs.exists }}" == "true" ]; then
            echo "ðŸ“¦ Using base image: ${{ steps.pull-base.outputs.base-image }}"
            docker build \
              --target deps \
              --file "${{ inputs.dockerfile-path }}/Dockerfile" \
              --build-arg BASE_IMAGE=${{ steps.pull-base.outputs.base-image }} \
              --build-arg SKIP_BASE_DEPS=true \
              $BUILD_ARGS \
              --cache-from ${{ steps.pull-base.outputs.base-image }} \
              -t "${{ steps.pull-deps.outputs.deps-image }}" \
              "${{ inputs.context }}"
          else
            echo "ðŸ—ï¸  Building from scratch (no base image)"
            docker build \
              --target deps \
              --file "${{ inputs.dockerfile-path }}/Dockerfile" \
              $BUILD_ARGS \
              -t "${{ steps.pull-deps.outputs.deps-image }}" \
              "${{ inputs.context }}"
          fi
      
      - name: Push dependency image to GHCR
        if: steps.pull-deps.outputs.exists == 'false' && inputs.push-images
        run: |
          echo "â¬†ï¸ Pushing dependency image to GHCR..."
          docker push "${{ steps.pull-deps.outputs.deps-image }}"
      
      - name: Build runtime image
        # Only build runtime if: (1) not explicitly skipped, AND (2) we're pushing it
        # Note: Tests will run on deps image when runtime is not built
        if: inputs.push-runtime && !inputs.skip-runtime
        run: |
          echo "ðŸ”¨ Building runtime image..."
          # Use the deps image as cache to speed up runtime build
          docker build \
            --build-arg DEPS_TAG=${{ steps.cache-key.outputs.cache-key }} \
            --cache-from ${{ steps.pull-deps.outputs.deps-image }} \
            --file "${{ inputs.dockerfile-path }}/Dockerfile" \
            -t "${{ inputs.runtime-image-name }}" \
            "${{ inputs.context }}"
      
      - name: Tag and push runtime image to GHCR
        if: inputs.push-runtime && inputs.push-images && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          echo "â¬†ï¸ Pushing runtime image to GHCR..."
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          RUNTIME_IMAGE="ghcr.io/${REPO_LOWER}:latest"
          docker tag "${{ inputs.runtime-image-name }}" "${RUNTIME_IMAGE}"
          docker push "${RUNTIME_IMAGE}"
          echo "âœ… Runtime image pushed: ${RUNTIME_IMAGE}"
      
      - name: Run tests
        # Run tests if custom test-command is provided
        # Uses runtime image if available, otherwise falls back to deps image
        if: inputs.test-command != 'echo "No tests specified"'
        run: |
          echo "ðŸ§ª Running tests..."
          
          # Determine which image to use for testing
          if docker image inspect "${{ inputs.runtime-image-name }}" >/dev/null 2>&1; then
            TEST_IMAGE="${{ inputs.runtime-image-name }}"
            USING_RUNTIME=true
            echo "âœ… Using runtime image for tests: ${TEST_IMAGE}"
          else
            TEST_IMAGE="${{ steps.pull-deps.outputs.deps-image }}"
            USING_RUNTIME=false
            echo "âš¡ Runtime image not built - using deps image for tests: ${TEST_IMAGE}"
          fi
          
          # When using deps image, mount the code since it's not in the image
          # When using runtime image, code is already baked in
          if [ "$USING_RUNTIME" = "false" ]; then
            echo "ðŸ“¦ Mounting workspace into container..."
            docker run --rm -v "${{ github.workspace }}:/workspace" -w /workspace "${TEST_IMAGE}" sh -c '${{ inputs.test-command }}'
          else
            docker run --rm "${TEST_IMAGE}" sh -c '${{ inputs.test-command }}'
          fi
